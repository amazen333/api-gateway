server:
  port: ${SERVER_PORT:8080}
  shutdown: graceful
  max-http-request-header-size: 8KB

spring:
  application:
    name: ${SPRING_APPLICATION_NAME:api-gateway}

  main:
    web-application-type: reactive
    banner-mode: off
    lazy-initialization: ${LAZY_INITIALIZATION:true}
    allow-circular-references: false
    allow-bean-definition-overriding: false

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      connect-timeout: 100ms
      timeout: 50ms
      client-type: lettuce
      lettuce:
        pool:
          enabled: true
          max-active: 32
          max-idle: 16
          min-idle: 8
          max-wait: 100ms
        shutdown-timeout: 100ms
        share-native-connection: true

  cache:
    type: caffeine
    caffeine:
      spec: maximumSize=10000,expireAfterWrite=5m
    cache-names:
      - jwt-cache
      - route-cache
      - config-cache

  cloud:
    gateway:
      metrics:
        enabled: ${GATEWAY_METRICS_ENABLED:false}

      discovery:
        locator:
          enabled: false

      httpclient:
        connect-timeout: 1000
        response-timeout: 5000
        pool:
          type: elastic
          max-connections: 10000
          max-idle-time: 30s
          max-life-time: 60s
          eviction-interval: 30s
          metrics: false
      compression:
          enabled: true
          min-response-size: 1024
          excluded-user-agents:
            - curl
            - HTTPie
            - Postman
            - Mozilla/5.0
          mime-types:
            - text/html
            - text/xml
            - text/plain
            - text/css
            - text/javascript
            - application/javascript
            - application/json
            - application/xml
      proxy:
          host: ${HTTP_PROXY_HOST:}
          port: ${HTTP_PROXY_PORT:0}
      ssl:
          use-insecure-trust-manager: false
          handshake-timeout: 10000

      websocket:
        max-frame-payload-length: 65536

      default-filters:
        - name: DedupeResponseHeader
          args:
            name: Access-Control-Allow-Credentials Access-Control-Allow-Origin
        - name: SetResponseHeader
          args:
            name: X-Response-Time
            value: "{{took}}"
        - name: SetResponseHeader
          args:
            name: Server
            value: "IoT-Gateway/1.0"

      routes:
        - id: public_api
          uri: ${PUBLIC_SERVICE_URI:lb://public-service}
          predicates:
            - Path=/api/v1/public/**,/health,/actuator/health
            - Method=GET
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 1000
                redis-rate-limiter.burstCapacity: 2000
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@ipKeyResolver}"
            - name: CacheRequestBody
            - name: StripPrefix
              args:
                parts: 2
            - name: SetResponseHeader
              args:
                name: X-Cache
                value: public

        - id: authenticated_api
          uri: ${AUTH_SERVICE_URI:lb://auth-service}
          predicates:
            - Path=/api/v1/auth/**
            - Method=GET,POST,PUT,DELETE
          filters:
            - name: CircuitBreaker
              args:
                name: authService
                fallbackUri: forward:/fallback/auth
            - name: JwtCachedAuthFilter
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 500
                redis-rate-limiter.burstCapacity: 1000
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@userKeyResolver}"
            - name: StripPrefix
              args:
                parts: 2
            - name: Retry
              args:
                retries: 3

        - id: device_api
          uri: ${DEVICE_SERVICE_URI:lb://device-service}
          predicates:
            - Path=/api/v1/devices/**,/api/v1/telemetry/**
            - Method=GET,POST
          filters:
            - name: CircuitBreaker
              args:
                name: deviceService
                fallbackUri: forward:/fallback/device
            - name: JwtCachedAuthFilter
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 2000
                redis-rate-limiter.burstCapacity: 5000
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@deviceKeyResolver}"
            - name: StripPrefix
              args:
                parts: 2
            - name: SetResponseHeader
              args:
                name: X-Cache-Control
                value: "no-transform"

        - id: websocket_route
          uri: ${WEBSOCKET_URI:lb:ws://websocket-service}
          predicates:
            - Path=/ws/**,/wss/**
          filters:
            - name: StripPrefix
              args:
                parts: 1

        - id: static_content
          uri: ${STATIC_CONTENT_URI:classpath:/static/}
          predicates:
            - Path=/static/**,/favicon.ico
          filters:
            - name: SetResponseHeader
              args:
                name: Cache-Control
                value: "public, max-age=31536000"

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,circuitbreakers,loggers
      base-path: /internal
