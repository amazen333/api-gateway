version: '3.9'

services:
  # Eureka Server
  eureka-server:
    image: springcloud/eureka
    container_name: eureka-server
    ports:
      - "8761:8761"
    networks:
      - iot-platform-network

  # API Gateway
  api-gateway:
    build: .
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=local-discovery
      - EUREKA_URL=http://eureka-server:8761/eureka/
      - SERVER_PORT=8080
    depends_on:
      - eureka-server
    networks:
      - iot-platform-network

  # Auth Service (sample microservice)
  auth-service:
    image: openjdk:17-jdk-slim
    container_name: auth-service
    working_dir: /app
    command: ["java", "-jar", "auth-service.jar"]
    volumes:
      - ./sample-services/auth-service.jar:/app/auth-service.jar
    environment:
      - SPRING_APPLICATION_NAME=auth-service
      - SERVER_PORT=8082
      - EUREKA_URL=http://eureka-server:8761/eureka/
    ports:
      - "8082:8082"
    depends_on:
      - eureka-server
    networks:
      - iot-platform-network

  # Device Service (sample microservice)
  device-service:
    image: openjdk:17-jdk-slim
    container_name: device-service
    working_dir: /app
    command: ["java", "-jar", "device-service.jar"]
    volumes:
      - ./sample-services/device-service.jar:/app/device-service.jar
    environment:
      - SPRING_APPLICATION_NAME=device-service
      - SERVER_PORT=8083
      - EUREKA_URL=http://eureka-server:8761/eureka/
    ports:
      - "8083:8083"
    depends_on:
      - eureka-server
    networks:
      - iot-platform-network

networks:
  iot-platform-network:
    driver: bridge
